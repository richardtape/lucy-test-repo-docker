# =============================================================================
# Apache Configuration for Web Nodes (Behind Load Balancer)
# =============================================================================
#
# This configuration is shared by all web nodes. Each node identifies itself
# using the NODE_NAME environment variable set in docker-compose.yml.
#
# KEY FEATURES:
#   - X-Served-By header: Identifies which node handled the request
#   - SERVERID cookie: Enables sticky sessions at the load balancer
#   - Health check endpoint: For load balancer health monitoring
#
# =============================================================================

# Pass NODE_NAME environment variable from system to Apache
# This is set in docker-compose.yml for each web node
PassEnv NODE_NAME

# Send all PHP files to PHP-FPM via Unix socket (FastCGI)
<FilesMatch \.php$>
    SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost/"
</FilesMatch>

# -----------------------------------------------------------------------------
# HTTP VirtualHost (Port 80)
# -----------------------------------------------------------------------------
# Note: When behind the load balancer, HTTP traffic is redirected at the LB.
# This VirtualHost handles direct access if needed for debugging.
# -----------------------------------------------------------------------------
<VirtualHost *:80>
    DocumentRoot "/www_data/www"

    # Redirect all HTTP traffic to HTTPS
    # Note: Load balancer handles this redirect, but kept for direct access
    RewriteEngine On
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# -----------------------------------------------------------------------------
# HTTPS VirtualHost (Port 443)
# -----------------------------------------------------------------------------
<VirtualHost *:443>
    ServerName cms.test
    DocumentRoot "/www_data/www"

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/pki/tls/certs/localhost.crt
    SSLCertificateKeyFile /etc/pki/tls/private/localhost.key

    <Directory "/www_data/www">
        AllowOverride All
        Require all granted
    </Directory>

    # -------------------------------------------------------------------------
    # STICKY SESSION COOKIE (SERVERID)
    # -------------------------------------------------------------------------
    # Set a cookie that identifies this web node. The load balancer reads this
    # cookie on subsequent requests to route the client back to the same node.
    #
    # Cookie attributes:
    #   - Value: NODE_NAME environment variable (e.g., "web-node-1")
    #   - Path: / (valid for all paths)
    #   - HttpOnly: Not accessible via JavaScript
    #   - Secure: Only sent over HTTPS
    #   - SameSite=Lax: Prevents CSRF while allowing normal navigation
    #
    # The cookie is set on every response to ensure it persists.
    # -------------------------------------------------------------------------
    Header always set Set-Cookie "SERVERID=%{NODE_NAME}e; Path=/; HttpOnly; Secure; SameSite=Lax" env=NODE_NAME

    # -------------------------------------------------------------------------
    # X-SERVED-BY HEADER
    # -------------------------------------------------------------------------
    # Adds a header to identify which web node handled the request.
    # Useful for debugging and verifying load balancing behavior.
    # Example: X-Served-By: web-node-1
    # -------------------------------------------------------------------------
    Header always set X-Served-By "%{NODE_NAME}e" env=NODE_NAME

    # -------------------------------------------------------------------------
    # HEALTH CHECK ENDPOINT
    # -------------------------------------------------------------------------
    # Health check is handled by /health.php on the NFS share.
    # The load balancer calls this endpoint to verify the node is alive.
    # See: nfs/exports/shared/health.php
    # -------------------------------------------------------------------------
</VirtualHost>

# Set Apache user (matches NFS permissions)
User websvc
Group webgrp

